<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/mic-recorder-to-mp3"
    ></script>

    <style id="compiled-css" type="text/css">
      /* EOS */
    </style>

    <script id="insert"></script>
  </head>
  <body>
    <div class="container text-center">
      <h1>Virtual Choir v0.1</h1>
      <p id="demo">INSTRUCTIONS:
        <br>1) Give Mic Permissions
        <br>2) START VIDEO (So it buffers)
        <br>3) Press "Start Recording"
        <br>4) When done, press "Stop Recording", the audio should appear below. Click the three dots and download it.
      </p>

      <hr />

      <button class="btn btn-primary" id="play">Start recording</button>
      <hr />

      <br />

      <div id="player"></div>

      <br />
      <button id="stop"></button>
      <br />

      <ul id="playlist"></ul>
    </div>

    <script type="text/javascript">
      var tag = document.createElement("script")

      tag.src = "https://www.youtube.com/iframe_api"
      var firstScriptTag = document.getElementsByTagName("script")[0]
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)

      var player
      function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
          height: "390",
          width: "640",
          videoId: "fecwbq1aKMI",
        })
      }
      function stopVideo() {
        player.stopVideo()
      }
      const button = document.querySelector("button")
      const recorder = new MicRecorder({
        bitRate: 128,
      })
      recorder.start();
      recorder.stop();

      button.addEventListener("click", runSync)

      function runSync() {
        startRecording();
        player.playVideo();
      }

      function startRecording() {
        // timedText();
        console.log(1)
        recorder
          .start()
          .then(() => {
            player.seekTo(0)
            console.log(2)
            button.textContent = "Stop recording"
            button.classList.toggle("btn-danger")
            button.removeEventListener("click", runSync)
            button.addEventListener("click", stopRecording)
            button.addEventListener("click", stopVideo)
          })
          .catch(e => {
            console.error(e)
          })
      }

      function stopRecording() {
        recorder
          .stop()
          .getMp3()
          .then(([buffer, blob]) => {
            console.log(buffer, blob)
            const file = new File(buffer, "music.mp3", {
              type: blob.type,
              lastModified: Date.now(),
            })

            const li = document.createElement("li")
            const player = new Audio(URL.createObjectURL(file))
            player.controls = true
            li.appendChild(player)
            document.querySelector("#playlist").appendChild(li)

            button.textContent = "Start recording"
            button.classList.toggle("btn-danger")
            button.removeEventListener("click", stopRecording)
            button.addEventListener("click", startRecording)
          })
          .catch(e => {
            console.error(e)
          })
      }
      function timedText() {
        setTimeout(myTimeout1, 1000)
        setTimeout(myTimeout2, 2000)
        setTimeout(myTimeout3, 3000)
      }
      function myTimeout1() {
        document.getElementById("demo").innerHTML = "3"
      }
      function myTimeout2() {
        document.getElementById("demo").innerHTML = "2"
      }
      function myTimeout3() {
        document.getElementById("demo").innerHTML = "1"
      }
    </script>

    <script>
      if (window.parent && window.parent.parent) {
        window.parent.parent.postMessage(
          [
            "resultsFrame",
            {
              height: document.body.getBoundingClientRect().height,
              slug: "rhepg1dx",
            },
          ],
          "*"
        )
      }

      // always overwrite window.name, in case users try to set it manually
      window.name = "result"
    </script>
  </body>
</html>
